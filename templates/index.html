<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Casino 7-24 CanlÄ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; background: #0a0a0a; color: white; display: flex; height: 100vh; margin: 0; }
        #side { width: 220px; background: #111; border-right: 2px solid #ff4500; padding: 15px; }
        #main { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 10px; }
        .video-wrap { display: flex; width: 100%; justify-content: center; gap: 10px; margin-bottom: 10px; }
        video { width: 45%; height: 260px; background: black; border: 2px solid #333; border-radius: 10px; object-fit: cover; }
        #chat { width: 90%; height: 220px; background: #161616; overflow-y: auto; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #222; }
        .user-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #222; transition: 0.2s; }
        .user-item:hover { background: #ff4500; color: black; }
        .btns { display: flex; gap: 10px; margin-bottom: 10px; }
        button { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        #msg-input { padding: 12px; width: 65%; border-radius: 6px; border: none; background: #222; color: white; }
    </style>
</head>
<body>
    <div id="side">
        <h3>ğŸ‘¥ Ãœyeler</h3>
        <div id="user-list">BaÄŸlanÄ±yor...</div>
    </div>
    <div id="main">
        <h3 id="status-title">ğŸŒ Genel Sohbet</h3>
        <div class="video-wrap">
            <video id="localVideo" autoplay playsinline muted></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
        <div class="btns" id="call-controls" style="display:none;">
            <button style="background:#28a745; color:white;" onclick="startCall()">ğŸ“ AramayÄ± BaÅŸlat</button>
            <button style="background:#dc3545; color:white;" onclick="closeCall()">âœ– Kapat</button>
        </div>
        <div id="chat"></div>
        <div style="width: 100%; text-align: center;">
            <input type="text" id="msg-input" placeholder="Mesaj yazÄ±n (Enter)...">
            <button onclick="send()" style="background:#ff4500; color:white;">GÃ¶nder</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = prompt("KullanÄ±cÄ± adÄ±nÄ±z:");
        let selectedUser = "";
        let pc; // PeerConnection
        let localStream;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        if(myName) socket.emit('register', myName);

        // Kamera BaÅŸlat
        navigator.mediaDevices.getUserMedia({video: true, audio: true})
            .then(s => { 
                localStream = s;
                document.getElementById('localVideo').srcObject = s; 
            });

        function send() {
            const input = document.getElementById('msg-input');
            if(!input.value) return;
            if(selectedUser) socket.emit('send_private_event', {target: selectedUser, message: input.value, type: 'private'});
            else socket.emit('send_global_msg', {message: input.value});
            input.value = "";
        }
        document.getElementById('msg-input').onkeypress = e => { if(e.key==='Enter') send(); };

        // GÃ¶rÃ¼ntÃ¼ BaÄŸlantÄ± FonksiyonlarÄ±
        async function startCall() {
            createPeer(selectedUser);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('signal', {target: selectedUser, data: offer});
        }

        function createPeer(targetName) {
            pc = new RTCPeerConnection(config);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
            pc.onicecandidate = e => {
                if(e.candidate) socket.emit('signal', {target: targetName, data: e.candidate});
            };
        }

        socket.on('signal', async (data) => {
            if(!pc) createPeer(data.sender);
            if(data.data.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.data));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('signal', {target: data.sender, data: answer});
            } else if(data.data.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.data));
            } else if(data.data.candidate) {
                await pc.addIceCandidate(new RTCIceCandidate(data.data));
            }
        });

        socket.on('update_user_list', list => {
            const div = document.getElementById('user-list');
            div.innerHTML = "<div class='user-item' onclick='reset()'>ğŸŒ Genel Sohbet</div>";
            list.forEach(u => {
                if(u !== myName) {
                    const item = document.createElement('div');
                    item.className = "user-item";
                    item.innerText = u;
                    item.onclick = () => { 
                        selectedUser = u; 
                        document.getElementById('status-title').innerText = "ğŸ‘¤ Ã–zel: " + u;
                        document.getElementById('call-controls').style.display = "flex";
                    };
                    div.appendChild(item);
                }
            });
        });

        function reset() { selectedUser = ""; document.getElementById('call-controls').style.display = "none"; }
        
        socket.on('receive_msg', d => {
            const area = document.getElementById('chat');
            area.innerHTML += `<div><b>${d.sender}:</b> ${d.message}</div>`;
            area.scrollTop = area.scrollHeight;
        });
    </script>
</body>
</html>
